<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <!--IE将使用最新的引擎渲染网页-->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!--页面的宽带与设备屏幕的宽度一致，初始缩放比例1:1-->
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>空间</title>
    <link rel="stylesheet" href="../static/css/bootstrap-4.4.1/bootstrap.min.css">
    <link rel="stylesheet" href="../static/toastr/toastr.css">
    <style type="text/css">
    </style>
    <!-- 图标库 https://icons.bootcss.com/#install -->
</head>

<body>
    <!-- Fixed navbar -->
    <nav class="navbar bg-light navbar-light fixed-top">
        <div class="col-sm-12 col-md-12 col-lg-12 col-xl-12 progress"
            style="height: 5px;padding-left: 0px; padding-right: 0px;display: none;">
            <div id="progress-panel" class="progress-bar progress-bar-striped" style="width: 0%"> </div>
        </div>
        <form id="uploadForm" class="container small " name="uploadForm" role="form" enctype="multipart/form-data"
            action="/upload" method="POST">
            <div class="d-flex flex-row ">
                <div id="upload-panel" class="input-group">
                    <input class="input-group-prepend" type="file" id="userfile" name="userfile" multiple />
                    <div class="input-group-append btn-group">
                        <button type="button" class="btn btn-primary btn-sm" id="upload"
                            onclick="UpLoadFile()">上传</button>
                    </div>
                </div>
            </div>
            <div class="d-flex  flex-row-reverse">
                <div id="file-panel" class="btn-group">
                    <button type="button" class="btn btn-primary btn-sm mr-auto" onclick="ShowUpload()"> <svg
                            xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                            class="bi bi-arrow-left-short" viewBox="0 0 16 16">
                            <path fill-rule="evenodd"
                                d="M12 8a.5.5 0 0 1-.5.5H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H11.5a.5.5 0 0 1 .5.5z" />
                        </svg> 取消</button>
                    <button type="button" class="btn btn-primary btn-sm" onclick="ChoiceAll()"> <svg
                            xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                            class="bi bi-check2-square" viewBox="0 0 16 16">
                            <path
                                d="M3 14.5A1.5 1.5 0 0 1 1.5 13V3A1.5 1.5 0 0 1 3 1.5h8a.5.5 0 0 1 0 1H3a.5.5 0 0 0-.5.5v10a.5.5 0 0 0 .5.5h10a.5.5 0 0 0 .5-.5V8a.5.5 0 0 1 1 0v5a1.5 1.5 0 0 1-1.5 1.5H3z" />
                            <path
                                d="m8.354 10.354 7-7a.5.5 0 0 0-.708-.708L8 9.293 5.354 6.646a.5.5 0 1 0-.708.708l3 3a.5.5 0 0 0 .708 0z" />
                        </svg> 全选</button>
                    <button type="button" class="btn btn-danger btn-sm" onclick="DelFile()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                            class="bi bi-trash" viewBox="0 0 16 16">
                            <path
                                d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z" />
                            <path fill-rule="evenodd"
                                d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z" />
                        </svg> 删除</button>
                </div>
            </div>
        </form>
    </nav>
    <div class="container small" style="padding-top: 46px;">
        <div class="d-flex">
            <table class="table tabl-light table-striped table-hover" style="word-break:break-all; word-wrap:break-all;"
                id="datas-panel">
                <thead>
                    <tr>
                        <th>名称</th>
                        <th>大小</th>
                        <th>修改日期</th>
                        <th>选择</th>
                    </tr>
                </thead>
                <tbody>
                    <tr id="template-panel">
                        <td id="Name"></td>
                        <td id="Size"></td>
                        <td id="ModTime"></td>
                        <td id="Operation"></td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="d-flex flex-row-reverse">
            <h6 id="assemble" class="text-muted"><strong>0 个文件 0 KB</strong></h6>
        </div>
    </div>

    <script src="../static/js/jquery-3.6.0.min.js"></script>
    <script src="../static/js/bootstrap-4.4.1/bootstrap.min.js"></script>
    <script src="../static/toastr/toastr.min.js"></script>
    <script>
        var space = "";
        var url = "";
        $(function () {
            var str = window.location.pathname;
            space = str.substr(str.lastIndexOf("/"));
            url = "/directory" + space;
            toastr.options.positionClass = 'toast-bottom-right';
            $("#file-panel").hide();
            ListFile();
        });
        function DelFile() {
            var filename = new Array();
            $(".file-checkbox").each(function () {
                if ($(this).is(':checked')) {
                    filename.push($(this).parent().prev().prev().prev().text());
                }
            });
            //没有选择时退出
            if (filename.length < 1) return;
            var o = new Object();
            o.filename = filename;
            $.ajax({
                type: 'DELETE',
                url: url,
                data: JSON.stringify(o),
                contentType: 'application/json',
                cache: false,
                success: function (msg) {
                    ListFile();
                    toastr.success("删除文件完成");
                },
                error: function () {
                    toastr.error("删除文件出错");

                },
                complete: ShowUpload(),
            });
        }

        function ListFile() {
            $(".myrow").remove();
            $.ajax({
                //使用get方法访问后台
                type: "GET",
                //返回json格式的数据
                dataType: "json",
                //要访问的后台地址
                url: url,
                cache: false,
                //msg为返回的数据，在这里做数据绑定
                success: function (msg) {
                    var count = 0;
                    var total = 0;
                    $("#template-panel").show();
                    var prefix = "<a href='/spaces" + space + "/";
                    $.each(msg, function (i, n) {
                        var row = $("#template-panel").clone();
                        row.addClass("myrow");
                        row.find("#Name").html(prefix + n.name + "'>" + n.name + "</a>");
                        var size = parseInt(n.size);
                        row.find("#Size").text(size.toLocaleString());
                        row.find("#ModTime").text(String(n.time).substring(2));
                        row.find("#Operation").html(
                            "<input class='file-checkbox' type='checkbox' value='" + i +
                            "' onclick='ShowChoice()'>");
                        //添加到模板的容器中
                        row.appendTo("#datas-panel");
                        count++;
                        total = total + size;
                    });
                    $("#assemble").text(count + " 个文件 " + total.toLocaleString() + " KB");
                    //隐藏模板
                    $("#template-panel").hide();
                },
                error: function () {
                    toastr.error("连接list错误");
                }
            });
        }
        var lock = false;
        function UpLoadFile() {
            if (lock) return;
            var str = $("#userfile").val();
            if (str.length == 0) {
                toastr.warning("请选择文件");
                return;
            }
            $(".progress").show();
            // FormData 对象
            var form = new FormData(document.forms.namedItem("uploadForm"));
            // XMLHttpRequest 对象
            var xhr = new XMLHttpRequest();
            xhr.open("post", url, true);
            // xhr.upload 储存上传过程中的信息
            xhr.upload.onprogress = function (ev) {
                var percent = 0;
                if (ev.lengthComputable) {
                    percent = 100 * ev.loaded / ev.total;
                    $("#progress-panel").width(percent + "%");
                    $("#upload").text(Math.trunc(ev.loaded / 1024).toLocaleString() + "/" + Math.trunc(ev.total / 1024)
                        .toLocaleString() + " KB");
                }
            };
            xhr.onload = function (oEvent) {
                if (xhr.status == 200) {
                    ListFile();
                    $("#userfile").val("");
                    $("#upload").text("上传");
                    toastr.success("文件上传完成");
                    setTimeout(function () {
                        $(".progress").hide();
                        $("#progress-panel").width("0%");
                    }, 1000);
                }
            }
            xhr.onreadystatechange = function () {
                switch (xhr.readyState) {
                    case 4:
                        lock = false;
                        break;
                }
            }
            lock = true;
            //发送数据
            xhr.send(form);
        }

        function ChoiceAll() {
            $(".file-checkbox").prop("checked", true)
        }

        function ShowChoice() {
            $("#upload-panel").hide();
            $("#file-panel").show();
        }

        function ShowUpload() {
            $(".file-checkbox").prop("checked", false)
            $("#file-panel").hide();
            $("#upload-panel").show();
        }
    </script>
</body>

</html>